<!DOCTYPE html>
<html>
<head>
    <title>BHChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // The following variables are not used in the WebSocket version, but are required for the Canvas environment.
        const firebaseConfig = {};
        const initialAuthToken = null;
        const appId = 'default-app-id';

        // Placeholder for WebSocket. Replace this with your own WSS server URL.
        const wssUrl = 'wss://bhchat.onrender.com';

        let ws;
        let userId = Math.random().toString(36).substring(2, 15); // A simple unique ID for this user
        let localUsername = localStorage.getItem('username') || '';
        let roomName;
        
        let isAuthReady = false;
        
        // This is a simplified "authentication" step to make sure the user has a username.
        function authSimulation() {
            isAuthReady = true;
            if (localUsername) {
                joinRoom();
            } else {
                statusMessage.textContent = 'Please enter a username and room name, then click Join.';
                joinButton.disabled = false;
            }
        }
        
        window.onload = authSimulation;

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        h1 { font-size: 2em; text-align: center; margin-bottom: 20px; }
        h2 { font-size: 1.5em; text-align: center; }
        h3 { font-size: 1.2em; margin-bottom: 10px; }
        p { font-size: 1em; }

        .chat-section {
            display: flex;
            gap: 20px;
        }
        .sidebar {
            width: 250px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .chat-container {
            flex-grow: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 400px;
        }
        #chatbox {
            flex-grow: 1;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 5px;
        }
        #chat-input-form { display: flex; }
        #chat-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #send-button:hover { background-color: #0056b3; }
        #upload-image-button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        .message { margin: 5px 0; }
        .my-message { text-align: right; color: #007bff; }
        .message img { max-width: 200px; display: block; }
        .active-rooms-container {
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        ul { list-style-type: none; padding: 0; }
        li {
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        li.active-chat {
            background-color: #e2e8f0;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl text-center font-bold mb-4">BHChat</h1>

    <div id="controls" class="text-center mb-4 p-4 bg-white rounded-lg shadow">
        <input type="text" id="username-input" placeholder="Enter your username" class="p-2 border rounded mr-2">
        <input type="text" id="room-input" placeholder="Enter Room Name" value="default-room" class="p-2 border rounded mr-2">
        <button id="join-button" class="p-2 px-4 bg-blue-500 text-white rounded">Join Room</button>
        <p id="status-message" class="mt-2 text-gray-600">Please enter a username and room name, then click Join.</p>
    </div>
    
    <div class="chat-section mt-4">
        <div class="sidebar p-4 bg-white rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-2">Online Users</h3>
            <ul id="online-users-list"></ul>
        </div>

        <div class="chat-container p-4 bg-white rounded-lg shadow flex flex-col h-96">
            <h2 id="chat-title" class="text-xl font-semibold mb-2">Room Chat</h2>
            <div id="chatbox" class="flex-grow overflow-y-auto border-b pb-2 mb-2"></div>
            <form id="chat-input-form" class="flex">
                <input type="file" id="image-input" accept="image/*" style="display:none;">
                <button type="button" id="upload-image-button" class="p-2 bg-gray-200 text-xl rounded mr-2">üñºÔ∏è</button>
                <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" class="flex-grow p-2 border rounded mr-2">
                <button type="submit" id="send-button" class="p-2 px-4 bg-blue-500 text-white rounded">Send</button>
            </form>
        </div>
    </div>

    <!-- The Active Rooms section is not supported with this simple WebSocket implementation -->
    <!-- <div class="active-rooms-container mt-4">
        <h2 class="text-xl font-semibold mb-2">Active Rooms</h2>
        <div id="active-rooms-list"></div>
    </div> -->
</div>

<script>
    // UI elements
    const chatbox = document.getElementById('chatbox');
    const chatInput = document.getElementById('chat-input');
    const chatInputForm = document.getElementById('chat-input-form');
    const roomInput = document.getElementById('room-input');
    const usernameInput = document.getElementById('username-input');
    const joinButton = document.getElementById('join-button');
    const statusMessage = document.getElementById('status-message');
    const imageInput = document.getElementById('image-input');
    const uploadImageButton = document.getElementById('upload-image-button');
    const onlineUsersList = document.getElementById('online-users-list');
    const chatTitle = document.getElementById('chat-title');
    
    // --- Core App Functions ---

    function joinRoom() {
        if (!isAuthReady) {
            console.error("Authentication not ready.");
            return;
        }

        // Close any existing WebSocket connection before creating a new one
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
        }

        ws = new WebSocket(wssUrl);

        ws.onopen = () => {
            console.log('WebSocket connected.');
            statusMessage.textContent = 'Connected to WSS server. Ready to chat.';
            joinButton.disabled = true;

            // Send a "join" message to the server
            const joinMessage = {
                type: 'join',
                room: roomName,
                userId: userId,
                username: localUsername
            };
            ws.send(JSON.stringify(joinMessage));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Received:', data);
            
            switch (data.type) {
                case 'message':
                    // A new message from the server
                    const isMyMessage = data.userId === userId;
                    if (data.messageType === 'text') {
                        addMessageToChat(isMyMessage ? 'You' : data.username, data.content, isMyMessage);
                    } else if (data.messageType === 'image') {
                        addImageToChat(isMyMessage ? 'You' : data.username, data.content, isMyMessage);
                    }
                    break;
                case 'users':
                    // An update to the list of online users
                    displayOnlineUsers(data.users);
                    break;
                case 'history':
                    // Initial message history from the server
                    chatbox.innerHTML = '';
                    data.messages.forEach(msg => {
                        const isMyMessage = msg.userId === userId;
                        if (msg.messageType === 'text') {
                            addMessageToChat(isMyMessage ? 'You' : msg.username, msg.content, isMyMessage);
                        } else if (msg.messageType === 'image') {
                            addImageToChat(isMyMessage ? 'You' : msg.username, msg.content, isMyMessage);
                        }
                    });
                    break;
                default:
                    console.warn('Unknown message type:', data.type);
            }
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed.');
            statusMessage.textContent = 'Connection to server lost. Please refresh or try again.';
            joinButton.disabled = false;
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            statusMessage.textContent = 'An error occurred with the connection. Check the console for details.';
        };
    }
    
    // --- Event Handlers ---

    joinButton.onclick = () => {
        localUsername = usernameInput.value.trim();
        roomName = roomInput.value.trim();
        if (localUsername && roomName) {
            localStorage.setItem('username', localUsername);
            statusMessage.textContent = `Joining room '${roomName}' as '${localUsername}'...`;
            joinRoom();
            chatTitle.textContent = `Room Chat: ${roomName}`;
        } else {
            alert('Please enter a valid username and room name.');
        }
    };
    
    chatInputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message === '' || ws.readyState !== WebSocket.OPEN) return;

        const chatMessage = {
            type: 'message',
            room: roomName,
            userId: userId,
            username: localUsername,
            messageType: 'text',
            content: message
        };
        ws.send(JSON.stringify(chatMessage));
        chatInput.value = '';
    });

    uploadImageButton.onclick = () => { imageInput.click(); };

    imageInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageData = e.target.result;
                const imageMessage = {
                    type: 'message',
                    room: roomName,
                    userId: userId,
                    username: localUsername,
                    messageType: 'image',
                    content: imageData
                };
                ws.send(JSON.stringify(imageMessage));
            };
            reader.readAsDataURL(file);
        }
        imageInput.value = '';
    };

    // --- UI Helper Functions ---

    function addMessageToChat(sender, message, isMyMessage = false) {
        const messageElement = document.createElement('div');
        messageElement.textContent = `${sender}: ${message}`;
        messageElement.classList.add('message', 'p-2', 'rounded-lg', 'my-2', 'break-words');
        if (isMyMessage) {
            messageElement.classList.add('bg-blue-100', 'text-right', 'ml-auto');
        } else {
            messageElement.classList.add('bg-gray-100', 'text-left', 'mr-auto');
        }
        chatbox.appendChild(messageElement);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    function addImageToChat(sender, imageData, isMyMessage = false) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'p-2', 'rounded-lg', 'my-2', 'break-words');
        if (isMyMessage) {
            messageElement.classList.add('bg-blue-100', 'text-right', 'ml-auto');
        } else {
            messageElement.classList.add('bg-gray-100', 'text-left', 'mr-auto');
        }

        const senderElement = document.createElement('span');
        senderElement.textContent = `${sender}: `;
        messageElement.appendChild(senderElement);

        const imageElement = document.createElement('img');
        imageElement.src = imageData;
        imageElement.classList.add('max-w-xs', 'rounded');
        messageElement.appendChild(imageElement);

        chatbox.appendChild(messageElement);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    function displayOnlineUsers(users) {
        onlineUsersList.innerHTML = '';
        if (users && users.length > 0) {
            users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.textContent = user.username;
                listItem.classList.add('p-2', 'hover:bg-gray-100', 'cursor-pointer', 'rounded');
                onlineUsersList.appendChild(listItem);
            });
        }
    }
    
</script>
</body>
</html>
